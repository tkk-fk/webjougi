<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ãªãã£ã¦æ¸¬ã‚‹ï¼ãƒ‡ã‚¸ã‚¿ãƒ«ã‚‚ã®ã•ã—</title>
  <style>
    :root{ --appH: 100vh; } /* JSã§visualViewporté«˜ã•ã‚’å…¥ã‚Œã‚‹ */

    html, body { height: 100%; }
    body{
      margin:0; padding:0; overflow:hidden;
      font-family:"Hiragino Kaku Gothic ProN","Noto Sans JP",system-ui,sans-serif;
      background:#f0f4f8;
      touch-action:none; user-select:none; -webkit-user-select:none; -webkit-touch-callout:none;
      position:fixed; inset:0;
    }

    #app{
      display:flex; flex-direction:column;
      height: var(--appH);
      width:100vw; position:relative;
    }

    .controls{
      padding:10px; background:#fff; border-bottom:2px solid #ccc;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      z-index:100; box-shadow:0 2px 5px rgba(0,0,0,0.1);
    }
    .btn-group{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    button{
      font-size:1.15rem; padding:10px 18px; border:none; border-radius:8px;
      cursor:pointer; font-weight:900; transition:transform .08s;
      -webkit-tap-highlight-color:transparent; touch-action:manipulation; white-space:nowrap;
    }
    button:active{ transform:scale(.96); }

    #btn-zoom{ background:#4CAF50; color:#fff; display:flex; align-items:center; gap:5px; }
    #btn-reset{ background:#FF9800; color:#fff; }
    #btn-calibrate{ background:#607D8B; color:#fff; font-size:.95rem; }

    #btn-color{ background:#9C27B0; color:#fff; display:flex; align-items:center; gap:5px; border:2px solid transparent; }
    #btn-color.active { background:#fff; color:#9C27B0; border:2px solid #9C27B0; }

    .readout{
      background:#f1f5f9; border:1px solid #e2e8f0;
      padding:8px 12px; border-radius:999px;
      font-weight:900; color:#0f172a; font-size:1rem;
      max-width:min(64vw, 720px);
    }
    .readout small{ font-weight:800; color:#475569; margin-left:6px; }

    #workspace{
      flex:1; min-height:0;
      position:relative; display:flex; justify-content:center; align-items:center;
      background:#eef;
      padding-bottom: env(safe-area-inset-bottom, 0px);
      padding-left: env(safe-area-inset-left, 0px);
      padding-right: env(safe-area-inset-right, 0px);
    }

    #guide-msg{
      position:absolute; top:18px; width:100%;
      text-align:center; color:#555; font-size:1.05rem;
      pointer-events:none; padding:0 10px; line-height:1.35;
    }

    /* ===== ã‚‚ã®ã•ã—æœ¬ä½“ ===== */
    #ruler-container{
      position:relative; height:150px; background:#fff;
      border:2px solid #333; border-radius:10px;
      box-shadow:5px 5px 15px rgba(0,0,0,0.2);
      overflow:hidden;
      transform-origin:left center;
      touch-action:none;
    }

    /* ã‚¹ãƒˆãƒ©ã‚¤ãƒ— */
    #stripes-layer{ position:absolute; inset:0; pointer-events:none; }
    .stripe{
      position:absolute; top:0;
      height:22px;
      pointer-events:none;
      transform: translateZ(0);
      transition: height 0.3s ease, opacity 0.3s ease;
    }

    /* è‰²ãƒ¢ãƒ¼ãƒ‰ON */
    .show-colors .stripe {
      height: 100% !important;
      opacity: 0.22; /* æŒ‡å®š */
    }

    /* ç›®ç››ã‚Š */
    #ticks-layer{ position:absolute; inset:0; pointer-events:none; }
    .tick{ position:absolute; bottom:0; width:2px; background:#333; pointer-events:none; }
    .tick-1mm{ height:15px; width:1px; background:#555; }
    .tick-5mm{ height:25px; width:2px; }
    .tick-10mm{ height:40px; width:3px; background:#000; }

    .tick-label{
      position:absolute; bottom:45px; transform:translateX(-50%);
      font-size:1.5rem; font-weight:900; color:#333;
      pointer-events:none; white-space:nowrap;
    }
    .label-strong{ color:#2563eb; }

    /* â˜…ç«¯ã®æ•°å­—ãŒåˆ‡ã‚Œãªã„ã‚ˆã†ã« */
    .tick-label.edge-left{ transform:translateX(0); left:4px !important; }
    .tick-label.edge-right{ transform:translateX(-100%); }

    /* 1cmä½ç½®ã®ä¸‰è§’ */
    .tri{
      position:absolute;
      bottom: 42px;
      width:0; height:0;
      border-left:7px solid transparent;
      border-right:7px solid transparent;
      border-top:10px solid #ef4444;
      transform:translateX(-50%);
      pointer-events:none;
      filter: drop-shadow(0 1px 0 rgba(0,0,0,0.08));
    }
    .tri.edge-left{ transform:translateX(0); left:0px !important; }
    .tri.edge-right{ transform:translateX(-100%); }

    /* ===== åŒºé–“å¡—ã‚Š ===== */
    #color-layer{
      position:absolute; top:0; height:100%;
      width:0; left:0;
      background: rgba(255, 0, 0, 0.28);
      border-right:2px solid rgba(185, 28, 28, 0.50);
      pointer-events:none;
      z-index:10;
    }
    #start-marker{
      position:absolute; bottom:0; height:100%;
      border-left:3px solid rgba(37,99,235,0.85);
      display:none; pointer-events:none;
      z-index:10;
    }

    /* ===== æ ¡æ­£ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆâ˜…var(--appH)ã§åˆ‡ã‚Œé˜²æ­¢ï¼‰ ===== */
    #calibration-modal{
      position:fixed; top:0; left:0; right:0;
      height: var(--appH);
      background:rgba(0,0,0,0.82);
      display:none; justify-content:center; align-items:center;
      z-index:999; color:#fff; flex-direction:column;
      padding: calc(16px + env(safe-area-inset-top, 0px)) 16px calc(16px + env(safe-area-inset-bottom, 0px)) 16px;
      gap:14px; touch-action:none;
      overflow:hidden;
    }
    #calibration-modal h2{ margin:0; font-size:1.4rem; }
    #calibration-modal p{
      margin:0; text-align:center; line-height:1.5; color:#e2e8f0;
      max-width:900px;
    }
    #calibration-box{
      background:#fff; color:#000;
      display:flex; justify-content:center; align-items:center;
      border-radius:10px; text-align:center; font-size:.95rem; font-weight:900;
      padding:10px; box-shadow:0 10px 30px rgba(0,0,0,0.35);
    }
    .calib-controls{ display:flex; gap:14px; align-items:center; justify-content:center; flex-wrap:wrap; }
    input[type="range"]{ width:min(520px, 86vw); touch-action:manipulation; }
    #ppm-label{
      background: rgba(255,255,255,0.12);
      border:1px solid rgba(255,255,255,0.18);
      padding:8px 12px; border-radius:999px; font-weight:900;
    }
    #btn-close-calib{ background:#fff; color:#000; font-weight:900; }

    /* ===== æ‹¡å¤§ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆâ˜…var(--appH)+safe-area+ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§åˆ‡ã‚Œé˜²æ­¢ï¼‰ ===== */
    #zoom-modal{
      position:fixed; top:0; left:0; right:0;
      height: var(--appH);
      background:rgba(0,0,0,0.75);
      display:none; justify-content:center; align-items:flex-end;
      z-index:998;
      padding: calc(14px + env(safe-area-inset-top, 0px)) 14px calc(14px + env(safe-area-inset-bottom, 0px)) 14px;
      touch-action:none;
      overflow:hidden;
    }
    .zoom-sheet{
      width:min(980px, 100%);
      background:#fff; border-radius:16px;
      box-shadow:0 18px 60px rgba(0,0,0,0.35);
      padding:12px;
      display:flex; flex-direction:column; gap:10px;

      /* â˜…ç”»é¢ãŒå°ã•ã„ã¨ãã«ä¸‹ãŒåˆ‡ã‚Œãªã„ã‚ˆã†ã« */
      max-height: calc(var(--appH) - 24px - env(safe-area-inset-top, 0px) - env(safe-area-inset-bottom, 0px));
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }
    .zoom-top{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .zoom-title{ font-size:1.1rem; font-weight:900; margin-right:auto; color:#0f172a; }
    .zoom-pill{
      background:#f1f5f9; border:1px solid #e2e8f0;
      padding:6px 10px; border-radius:999px; font-weight:900; color:#0f172a;
    }
    .zoom-viewport{
      position:relative; width:100%;
      height: clamp(130px, 22vh, 180px); /* â˜…å°ã•ã„ç”»é¢ã§ã¯ä½ããªã‚‹ */
      background:#eef2ff; border-radius:12px; overflow:hidden;
      border:1px solid #c7d2fe; touch-action:none;
    }
    .zoom-centerline{
      position:absolute; top:0; bottom:0; left:50%;
      width:0; border-left:4px solid rgba(37,99,235,0.85);
      pointer-events:none; z-index:20;
    }
    #zoom-ruler{
      position:absolute; left:0; top:50%;
      transform:translateY(-50%);
      height:150px; background:#fff;
      border:2px solid #333; border-radius:10px;
      box-shadow:5px 5px 15px rgba(0,0,0,0.2);
      overflow:hidden;
    }
    #zoom-stripes{ position:absolute; inset:0; pointer-events:none; }
    #zoom-ticks{ position:absolute; inset:0; pointer-events:none; }
    #zoom-color{
      position:absolute; top:0; height:100%; width:0; left:0;
      background: rgba(255, 0, 0, 0.22);
      border-right:2px solid rgba(185, 28, 28, 0.45);
      pointer-events:none;
    }
    .zoom-controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .zoom-controls button{ font-size:1rem; padding:10px 14px; border-radius:10px; }
    #zoom-close{ background:#e2e8f0; color:#0f172a; }
    #zoom-minus,#zoom-plus{ background:#fff; border:1px solid #cbd5e1; color:#0f172a; }
    #zoom-factor{ background:#16a34a; color:#fff; }
    #zoom-center{ width:min(640px, 100%); flex:1; }
    .tiny-note{ font-size:.9rem; color:#475569; line-height:1.35; margin-top:2px; }

    /* =========================================================
       æ¨ªå‘ãå°‚ç”¨ï¼ˆé«˜ã•ãŒå°ã•ã„ç«¯æœ«ã§è©°ã‚ã‚‹ï¼‰
       ========================================================= */
    @media (orientation: landscape) and (max-height: 500px){
      .controls{ padding:6px 8px; gap:8px; }
      .btn-group{ gap:8px; }
      button{ font-size:0.95rem; padding:8px 12px; border-radius:10px; }
      #btn-calibrate{ font-size:0.9rem; }
      .readout{ font-size:0.92rem; padding:6px 10px; max-width:min(58vw, 520px); }
      .readout small{ font-size:0.86rem; }
      #guide-msg{ top:10px; font-size:0.92rem; line-height:1.25; }

      #ruler-container{ height:122px; }
      .tick-1mm{ height:12px; }
      .tick-5mm{ height:20px; }
      .tick-10mm{ height:32px; }
      .tick-label{ bottom:36px; font-size:1.25rem; }
      .tri{ bottom:34px; }

      /* æ‹¡å¤§å´ã‚‚åˆã‚ã›ã‚‹ */
      #zoom-ruler{ height:122px; }
      .zoom-viewport{ height: clamp(120px, 26vh, 150px); }
      .zoom-title{ font-size:1.0rem; }
      .zoom-controls button{ font-size:0.95rem; padding:8px 12px; }
      .tiny-note{ font-size:0.85rem; }
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="controls">
      <div class="btn-group">
        <button id="btn-calibrate">âš™ï¸ èª¿æ•´</button>
        <div class="readout" id="readout">é•·ã•ï¼šâ€” <small>ï¼ˆé•·æŠ¼ã—ã—ã¦ãªãã‚‹ï¼‰</small></div>
      </div>
      <div class="btn-group">
        <button id="btn-color">ğŸ¨ ã„ã‚</button>
        <button id="btn-zoom">ğŸ” æ‹¡å¤§</button>
        <button id="btn-reset">â†º æ¶ˆã™</button>
      </div>
    </div>

    <div id="workspace">
      <div id="guide-msg">
        ã“ã“ã«æ¸¬ã‚ŠãŸã„ã‚‚ã®ã‚’ç½®ã„ã¦ã€<b>é•·æŠ¼ã—</b>ã—ã¦ã‹ã‚‰æŒ‡ã§ãªãã‚ã†<br>
        ï¼ˆèª¤ã‚¿ãƒƒãƒé˜²æ­¢ï¼šé•·æŠ¼ã—ã—ãªã„ã¨è‰²ãŒã¤ãã¾ã›ã‚“ï¼‰
      </div>

      <div id="ruler-container" aria-label="ã‚‚ã®ã•ã—">
        <div id="stripes-layer"></div>
        <div id="color-layer"></div>
        <div id="start-marker"></div>
        <div id="ticks-layer"></div>
      </div>
    </div>
  </div>

  <div id="calibration-modal" role="dialog" aria-modal="true">
    <h2>å¤§ãã•ã®èª¿æ•´ï¼ˆå®Ÿå¯¸ã«åˆã‚ã›ã‚‹ï¼‰</h2>
    <p>
      ç”»é¢ä¸Šã®ç™½ã„ã‚«ãƒ¼ãƒ‰æ ãŒã€æ‰‹å…ƒã®ã‚«ãƒ¼ãƒ‰ï¼ˆã‚¯ãƒ¬ã‚«/ãƒã‚¤ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ãªã©ï¼‰ã¨<br>
      <b>ã´ã£ãŸã‚ŠåŒã˜å¹…ï¼ˆ85.60mmï¼‰</b>ã«ãªã‚‹ã‚ˆã†ã«ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’å‹•ã‹ã—ã¦ãã ã•ã„ã€‚
    </p>
    <div id="calibration-box">ã“ã“ã«ã‚«ãƒ¼ãƒ‰ã‚’é‡ã­ã¦<br>ã‚µã‚¤ã‚ºã‚’åˆã‚ã›ã¦ã­</div>

    <div class="calib-controls">
      <span>å°</span>
      <input type="range" id="px-per-mm-slider" min="2.00" max="8.50" step="0.01" value="3.78">
      <span>å¤§</span>
      <span id="ppm-label">1mm = 3.78px</span>
    </div>

    <button id="btn-close-calib">å®Œäº†</button>
  </div>

  <div id="zoom-modal" role="dialog" aria-modal="true">
    <div class="zoom-sheet">
      <div class="zoom-top">
        <div class="zoom-title">ğŸ” ç›®ç››ã‚Šã‚’æ‹¡å¤§ï¼ˆèª­ã¿ã‚„ã™ãï¼‰</div>
        <div class="zoom-pill" id="zoom-info">ä¸­å¿ƒï¼šâ€”</div>
        <button id="zoom-close">é–‰ã˜ã‚‹</button>
      </div>

      <div class="zoom-viewport">
        <div class="zoom-centerline"></div>
        <div id="zoom-ruler">
          <div id="zoom-stripes"></div>
          <div id="zoom-color"></div>
          <div id="zoom-ticks"></div>
        </div>
      </div>

      <div class="zoom-controls">
        <button id="zoom-minus">ï¼</button>
        <button id="zoom-factor">å€ç‡ï¼šx3</button>
        <button id="zoom-plus">ï¼‹</button>
        <input type="range" id="zoom-center" min="0" max="200" step="1" value="0">
      </div>
      <div class="tiny-note">
        ãƒ»ä¸­å¿ƒã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§è¦‹ãŸã„ä½ç½®ã«åˆã‚ã›ã‚‰ã‚Œã¾ã™<br>
        ãƒ»æ‹¡å¤§ä¸­ã¯â€œèª­ã‚€å°‚ç”¨â€ã§ã™ï¼ˆè‰²ä»˜ã‘ã¯ãƒ¡ã‚¤ãƒ³ç”»é¢ã§ï¼‰
      </div>
    </div>
  </div>

<script>
(() => {
  // ===== iPhoneæ¨ªå‘ãå¯¾ç­–ï¼šè¦‹ãˆã¦ã„ã‚‹é«˜ã•(visual viewport)ã‚’ä½¿ã† =====
  function setAppHeight(){
    const h = window.visualViewport ? window.visualViewport.height : window.innerHeight;
    document.documentElement.style.setProperty("--appH", `${Math.round(h)}px`);
  }
  setAppHeight();
  window.addEventListener("resize", setAppHeight);
  window.addEventListener("orientationchange", ()=>setTimeout(setAppHeight, 200));
  if (window.visualViewport){
    window.visualViewport.addEventListener("resize", setAppHeight);
    window.visualViewport.addEventListener("scroll", setAppHeight);
  }

  // ===== è¨­å®š =====
  const STORAGE_KEY = "ruler_px_per_mm_v5";
  const DEFAULT_PPM = 3.78;
  const RULER_LENGTH_MM = 200;    // 20cm
  const LONGPRESS_MS = 260;       // èª¤ã‚¿ãƒƒãƒé˜²æ­¢

  // è‰²è¨­å®šï¼ˆé’Ã—ã‚ªãƒ¬ãƒ³ã‚¸ + æŠœãè–„ã‚°ãƒ¬ãƒ¼ï¼‰
  const STRIPE_PURPLE = "#0072B2"; // é’
  const STRIPE_BLUE   = "#E69F00"; // ã‚ªãƒ¬ãƒ³ã‚¸
  const STRIPE_WHITE  = "#F1F5F9"; // æŠœãï¼ˆè–„ã‚°ãƒ¬ãƒ¼ï¼‰
  const STRIPE_H_MAIN = 22;
  const STRIPE_H_ZOOM = 22;

  // ===== è¦ç´  =====
  const rulerContainer = document.getElementById("ruler-container");
  const stripesLayer   = document.getElementById("stripes-layer");
  const ticksLayer     = document.getElementById("ticks-layer");
  const colorLayer     = document.getElementById("color-layer");
  const startMarker    = document.getElementById("start-marker");

  const btnZoom      = document.getElementById("btn-zoom");
  const btnReset     = document.getElementById("btn-reset");
  const btnCalibrate = document.getElementById("btn-calibrate");
  const btnColor     = document.getElementById("btn-color");

  const modalCal     = document.getElementById("calibration-modal");
  const sliderPPM    = document.getElementById("px-per-mm-slider");
  const ppmLabel     = document.getElementById("ppm-label");
  const btnCloseCal  = document.getElementById("btn-close-calib");
  const calibBox     = document.getElementById("calibration-box");

  const readout = document.getElementById("readout");

  const zoomModal     = document.getElementById("zoom-modal");
  const zoomClose     = document.getElementById("zoom-close");
  const zoomRuler     = document.getElementById("zoom-ruler");
  const zoomStripes   = document.getElementById("zoom-stripes");
  const zoomTicks     = document.getElementById("zoom-ticks");
  const zoomColor     = document.getElementById("zoom-color");
  const zoomInfo      = document.getElementById("zoom-info");
  const zoomCenter    = document.getElementById("zoom-center");
  const zoomMinus     = document.getElementById("zoom-minus");
  const zoomPlus      = document.getElementById("zoom-plus");
  const zoomFactorBtn = document.getElementById("zoom-factor");

  // ===== çŠ¶æ…‹ =====
  let pxPerMm = DEFAULT_PPM;

  let paintActive = false;
  let pressTimer = null;
  let pointerId = null;
  let startMm = null;
  let endMm = null;

  let zoomOpen = false;
  let zoomFactor = 3;
  let zoomCenterMm = 0;

  let isColorMode = false;

  // ===== util =====
  const clamp = (v,min,max)=>Math.max(min, Math.min(max,v));
  const mmToPx = (mm)=> mm * pxPerMm;

  function mmFromClientX(clientX){
    const rect = rulerContainer.getBoundingClientRect();
    let x = clientX - rect.left;
    x = clamp(x, 0, rect.width);
    const mm = Math.round(x / pxPerMm);
    return clamp(mm, 0, RULER_LENGTH_MM);
  }

  function formatLen(mm){
    if (mm == null) return "â€”";
    const cm = mm / 10;
    return `${cm.toFixed(1)} cmï¼ˆ${mm}mmï¼‰`;
  }

  function setReadout(){
    if (startMm == null || endMm == null){
      readout.innerHTML = `é•·ã•ï¼šâ€” <small>ï¼ˆé•·æŠ¼ã—ã—ã¦ãªãã‚‹ï¼‰</small>`;
      return;
    }
    const a = Math.min(startMm, endMm);
    const b = Math.max(startMm, endMm);
    const len = Math.max(1, b - a);
    readout.innerHTML = `é•·ã•ï¼š${formatLen(len)} <small>ï¼ˆ${a}mm â†’ ${b}mmï¼‰</small>`;
  }

  function stripeColorForMm(i){
    const cm = Math.floor(i / 10);
    const base = (cm % 2 === 0) ? STRIPE_PURPLE : STRIPE_BLUE; // å¶æ•°cm=é’, å¥‡æ•°cm=ã‚ªãƒ¬ãƒ³ã‚¸
    const isBase = (i % 2 === 0);                               // å¶æ•°mm=è‰², å¥‡æ•°mm=æŠœã
    return isBase ? base : STRIPE_WHITE;
  }

  // ===== æç”»ï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰ =====
  function drawRuler(){
    stripesLayer.innerHTML = "";
    ticksLayer.innerHTML = "";

    const totalWidth = RULER_LENGTH_MM * pxPerMm;
    rulerContainer.style.width = `${totalWidth}px`;

    // ã‚¹ãƒˆãƒ©ã‚¤ãƒ—
    for (let i = 0; i < RULER_LENGTH_MM; i++){
      const s = document.createElement("div");
      s.className = "stripe";
      s.style.left = `${(i * pxPerMm).toFixed(2)}px`;
      s.style.width = `${pxPerMm.toFixed(2)}px`;
      s.style.height = `${STRIPE_H_MAIN}px`;
      s.style.background = stripeColorForMm(i);
      stripesLayer.appendChild(s);
    }

    // ç›®ç››ã‚Š
    for (let i = 0; i <= RULER_LENGTH_MM; i++){
      const x = i * pxPerMm;
      const tick = document.createElement("div");
      tick.classList.add("tick");
      tick.style.left = `${x.toFixed(2)}px`;

      if (i % 10 === 0){
        tick.classList.add("tick-10mm");

        const tri = document.createElement("div");
        tri.className = "tri";
        tri.style.left = `${x.toFixed(2)}px`;
        if (i === 0) { tri.classList.add("edge-left"); tri.style.left = `0px`; }
        if (i === RULER_LENGTH_MM) tri.classList.add("edge-right");
        ticksLayer.appendChild(tri);

        const label = document.createElement("div");
        label.classList.add("tick-label");
        label.innerText = i / 10;
        label.style.left = `${x.toFixed(2)}px`;
        if ((i/10) % 5 === 0) label.classList.add("label-strong");
        if (i === 0) { label.classList.add("edge-left"); label.style.left = `0px`; }
        if (i === RULER_LENGTH_MM) label.classList.add("edge-right");
        ticksLayer.appendChild(label);

      } else if (i % 5 === 0){
        tick.classList.add("tick-5mm");
      } else {
        tick.classList.add("tick-1mm");
      }
      ticksLayer.appendChild(tick);
    }
    applyPaint();
  }

  // ===== åŒºé–“å¡—ã‚Š =====
  function applyPaint(){
    if (startMm == null || endMm == null){
      colorLayer.style.width = "0px";
      colorLayer.style.left  = "0px";
      startMarker.style.display = "none";
      setReadout();
      return;
    }
    const a = Math.min(startMm, endMm);
    const b = Math.max(startMm, endMm);

    colorLayer.style.left  = `${mmToPx(a)}px`;
    colorLayer.style.width = `${Math.max(1, mmToPx(b-a))}px`;

    startMarker.style.display = "block";
    startMarker.style.left = `${mmToPx(startMm)}px`;

    setReadout();
    if (zoomOpen) applyZoomPaint();
  }

  // ===== ã‚¤ãƒ™ãƒ³ãƒˆ =====
  document.addEventListener("touchmove", (e)=>{
    const t = e.target;
    if (t && t.tagName === "INPUT" && t.type === "range") return;
    e.preventDefault();
  }, {passive:false});

  function clearPressTimer(){
    if (pressTimer){ clearTimeout(pressTimer); pressTimer = null; }
  }

  function onPointerDown(e){
    if (zoomOpen) return;
    e.preventDefault();
    rulerContainer.setPointerCapture(e.pointerId);
    pointerId = e.pointerId;

    const mm = mmFromClientX(e.clientX);
    paintActive = false;
    clearPressTimer();
    pressTimer = setTimeout(()=>{
      pressTimer = null;
      paintActive = true;
      startMm = mm;
      endMm = mm;
      applyPaint();
    }, LONGPRESS_MS);
  }

  function onPointerMove(e){
    if (zoomOpen) return;
    if (pointerId !== e.pointerId) return;
    e.preventDefault();
    if (!paintActive) return;
    endMm = mmFromClientX(e.clientX);
    applyPaint();
  }

  function onPointerUp(e){
    if (zoomOpen) return;
    if (pointerId !== e.pointerId) return;
    e.preventDefault();
    clearPressTimer();
    if (!paintActive){ pointerId = null; return; }
    if (startMm != null && endMm != null && startMm === endMm){
      endMm = clamp(endMm + 1, 0, RULER_LENGTH_MM);
    }
    paintActive = false;
    pointerId = null;
    applyPaint();
  }

  function onPointerCancel(){
    clearPressTimer();
    paintActive = false;
    pointerId = null;
  }

  rulerContainer.addEventListener("pointerdown", onPointerDown);
  rulerContainer.addEventListener("pointermove", onPointerMove);
  rulerContainer.addEventListener("pointerup", onPointerUp);
  rulerContainer.addEventListener("pointercancel", onPointerCancel);

  // ===== ãƒœã‚¿ãƒ³ =====
  btnReset.addEventListener("click", ()=>{ startMm = null; endMm = null; applyPaint(); });

  btnColor.addEventListener("click", () => {
    isColorMode = !isColorMode;
    if (isColorMode) {
      rulerContainer.classList.add("show-colors");
      zoomRuler.classList.add("show-colors");
      btnColor.classList.add("active");
      btnColor.textContent = "ğŸ¨ ã„ã‚ ON";
    } else {
      rulerContainer.classList.remove("show-colors");
      zoomRuler.classList.remove("show-colors");
      btnColor.classList.remove("active");
      btnColor.textContent = "ğŸ¨ ã„ã‚";
    }
  });

  // ===== æ ¡æ­£ =====
  function updateCalibrationBox(){
    const w = 85.60 * pxPerMm;
    const h = 54.00 * pxPerMm;
    calibBox.style.width  = `${w}px`;
    calibBox.style.height = `${h}px`;
    ppmLabel.textContent = `1mm = ${pxPerMm.toFixed(2)}px`;
    drawRuler();
    if (zoomOpen) rebuildZoomRuler();
  }
  btnCalibrate.addEventListener("click", ()=> modalCal.style.display = "flex");
  btnCloseCal.addEventListener("click", ()=> {
    modalCal.style.display = "none";
    localStorage.setItem(STORAGE_KEY, String(pxPerMm));
  });
  sliderPPM.addEventListener("input", (e)=>{ pxPerMm = parseFloat(e.target.value); updateCalibrationBox(); });

  // ===== æ‹¡å¤§ =====
  function rebuildZoomRuler(){
    const pxPerMmZoom = pxPerMm * zoomFactor;
    const totalWidth = RULER_LENGTH_MM * pxPerMmZoom;
    zoomStripes.innerHTML = "";
    zoomTicks.innerHTML = "";
    zoomRuler.style.width = `${totalWidth}px`;

    for (let i = 0; i < RULER_LENGTH_MM; i++){
      const s = document.createElement("div");
      s.className = "stripe";
      s.style.left = `${(i * pxPerMmZoom).toFixed(2)}px`;
      s.style.width = `${pxPerMmZoom.toFixed(2)}px`;
      s.style.height = `${STRIPE_H_ZOOM}px`;
      s.style.background = stripeColorForMm(i);
      zoomStripes.appendChild(s);
    }

    for (let i = 0; i <= RULER_LENGTH_MM; i++){
      const x = i * pxPerMmZoom;
      const tick = document.createElement("div");
      tick.classList.add("tick");
      tick.style.left = `${x.toFixed(2)}px`;

      if (i % 10 === 0){
        tick.classList.add("tick-10mm");

        const tri = document.createElement("div");
        tri.className = "tri";
        tri.style.left = `${x.toFixed(2)}px`;
        if (i === 0) { tri.classList.add("edge-left"); tri.style.left = `0px`; }
        if (i === RULER_LENGTH_MM) tri.classList.add("edge-right");
        zoomTicks.appendChild(tri);

        const label = document.createElement("div");
        label.classList.add("tick-label");
        label.innerText = i / 10;
        label.style.left = `${x.toFixed(2)}px`;
        if ((i/10) % 5 === 0) label.classList.add("label-strong");
        if (i === 0) { label.classList.add("edge-left"); label.style.left = `0px`; }
        if (i === RULER_LENGTH_MM) label.classList.add("edge-right");
        zoomTicks.appendChild(label);

      } else if (i % 5 === 0){
        tick.classList.add("tick-5mm");
      } else {
        tick.classList.add("tick-1mm");
      }
      zoomTicks.appendChild(tick);
    }
    applyZoomPaint();
    updateZoomPosition();
  }

  function applyZoomPaint(){
    if (startMm == null || endMm == null){
      zoomColor.style.width = "0px"; zoomColor.style.left = "0px"; return;
    }
    const pxPerMmZoom = pxPerMm * zoomFactor;
    const a = Math.min(startMm, endMm);
    const b = Math.max(startMm, endMm);
    zoomColor.style.left  = `${(a * pxPerMmZoom).toFixed(2)}px`;
    zoomColor.style.width = `${Math.max(1, (b-a) * pxPerMmZoom).toFixed(2)}px`;
  }

  function updateZoomPosition(){
    const viewport = zoomRuler.parentElement;
    const vpW = viewport.clientWidth;
    const pxPerMmZoom = pxPerMm * zoomFactor;
    const totalWidth = RULER_LENGTH_MM * pxPerMmZoom;
    zoomCenterMm = clamp(zoomCenterMm, 0, RULER_LENGTH_MM);
    const centerPx = zoomCenterMm * pxPerMmZoom;
    let tx = (vpW/2) - centerPx;
    tx = clamp(tx, vpW - totalWidth, 0);
    zoomRuler.style.transform = `translate(${tx}px, -50%)`;
    zoomInfo.textContent = `ä¸­å¿ƒï¼š${(zoomCenterMm/10).toFixed(1)} cmï¼ˆ${zoomCenterMm}mmï¼‰`;
  }

  function openZoom(){
    zoomOpen = true;
    zoomModal.style.display = "flex";
    btnZoom.style.backgroundColor = "#d32f2f";
    btnZoom.textContent = "ğŸ” å…ƒã«æˆ»ã™";
    zoomCenterMm = (startMm != null && endMm != null) ? Math.round((startMm + endMm)/2) : 0;
    zoomCenter.max = String(RULER_LENGTH_MM);
    zoomCenter.value = String(zoomCenterMm);
    zoomFactorBtn.textContent = `å€ç‡ï¼šx${zoomFactor}`;
    rebuildZoomRuler();
    if(isColorMode) zoomRuler.classList.add("show-colors");
    else zoomRuler.classList.remove("show-colors");
  }

  function closeZoom(){
    zoomOpen = false;
    zoomModal.style.display = "none";
    btnZoom.style.backgroundColor = "#4CAF50";
    btnZoom.textContent = "ğŸ” æ‹¡å¤§";
  }

  btnZoom.addEventListener("click", ()=>{ if (!zoomOpen) openZoom(); else closeZoom(); });
  zoomClose.addEventListener("click", closeZoom);
  zoomCenter.addEventListener("input", (e)=>{ zoomCenterMm = parseInt(e.target.value, 10); updateZoomPosition(); });
  zoomMinus.addEventListener("click", ()=>{ zoomFactor = clamp(zoomFactor - 1, 2, 6); zoomFactorBtn.textContent = `å€ç‡ï¼šx${zoomFactor}`; rebuildZoomRuler(); });
  zoomPlus.addEventListener("click", ()=>{ zoomFactor = clamp(zoomFactor + 1, 2, 6); zoomFactorBtn.textContent = `å€ç‡ï¼šx${zoomFactor}`; rebuildZoomRuler(); });
  zoomModal.addEventListener("pointerdown", (e)=>{ if (e.target === zoomModal) closeZoom(); });
  window.addEventListener("resize", ()=>{ if (zoomOpen) updateZoomPosition(); });

  // Init
  function init(){
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved && isFinite(Number(saved))) pxPerMm = parseFloat(saved);
    sliderPPM.value = String(pxPerMm);
    ppmLabel.textContent = `1mm = ${pxPerMm.toFixed(2)}px`;
    updateCalibrationBox();
    setReadout();
  }
  init();
})();
</script>
</body>
</html>
