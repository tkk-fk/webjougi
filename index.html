<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>UDã‚«ãƒ©ãƒ¼ã‚‚ã®ã•ã—</title>
  <style>
    /* ===== åŸºæœ¬è¨­å®š ===== */
    html, body { 
      height: 100%; 
      /* ãƒ¢ãƒã‚¤ãƒ«ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å¯¾ç­– (dynamic viewport height) */
      height: 100dvh; 
    }
    body{
      margin:0; padding:0; overflow:hidden;
      font-family:"Hiragino Kaku Gothic ProN","Noto Sans JP",system-ui,sans-serif;
      background:#f4f7f9;
      touch-action:none; user-select:none; -webkit-user-select:none; -webkit-touch-callout:none;
      position:fixed; inset:0;
    }

    #app{ 
      display:flex; flex-direction:column; 
      height:100%; width:100%; position:relative; 
    }

    /* ===== ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒãƒ¼ ===== */
    .controls{
      background:#fff; border-bottom:1px solid #cbd5e1;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      z-index:100; box-shadow:0 2px 4px rgba(0,0,0,0.05);
      
      /* iPhoneã®ãƒãƒƒãƒãƒ»ãƒ›ãƒ¼ãƒ ãƒãƒ¼å¯¾å¿œã®ä½™ç™½ */
      padding: 10px;
      padding-left: max(10px, env(safe-area-inset-left));
      padding-right: max(10px, env(safe-area-inset-right));
      padding-top: max(10px, env(safe-area-inset-top));
    }
    .btn-group{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    button{
      font-size:1rem; padding:8px 14px; border:none; border-radius:8px;
      cursor:pointer; font-weight:700; transition:transform .08s;
      -webkit-tap-highlight-color:transparent; touch-action:manipulation; white-space:nowrap;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    button:active{ transform:scale(.96); }
    
    /* UDé…è‰²ã®ãƒœã‚¿ãƒ³ */
    #btn-zoom{ background:#00796B; color:#fff; display:flex; align-items:center; gap:5px; } 
    #btn-reset{ background:#E65100; color:#fff; } 
    #btn-calibrate{ background:#546E7A; color:#fff; font-size:.9rem; } 
    
    #btn-color{ 
        background:#fff; color:#333; border:2px solid #333; 
        display:flex; align-items:center; gap:5px; 
    }
    #btn-color.active { background:#333; color:#fff; }

    .readout{
      background:#fff; border:2px solid #90A4AE;
      padding:6px 12px; border-radius:999px;
      font-weight:900; color:#263238; font-size:0.95rem;
      white-space: nowrap;
    }
    .readout small{ font-weight:700; color:#546E7A; margin-left:6px; font-size:0.8rem;}

    #workspace{
      flex:1; position:relative; display:flex; justify-content:center; align-items:center;
      background:#ECEFF1;
      overflow: hidden; /* ã¯ã¿å‡ºã—é˜²æ­¢ */
      
      /* æ¨ªå‘ãæ™‚ã®å·¦å³ã®ã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢ç¢ºä¿ */
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
      padding-bottom: env(safe-area-inset-bottom);
    }

    #guide-msg{
      position:absolute; top:10px; width:100%;
      text-align:center; color:#37474F; font-size:1rem; font-weight:bold;
      pointer-events:none; padding:0 10px; line-height:1.4;
      text-shadow: 0 1px 0 rgba(255,255,255,0.8);
      z-index: 50;
    }

    /* ===== ã‚‚ã®ã•ã—æœ¬ä½“ ===== */
    #ruler-container{
      position:relative; 
      /* æ¨ªå‘ãç”»é¢ç”¨ã«é«˜ã•ã‚’å°‘ã—ã‚¹ãƒªãƒ ã«èª¿æ•´ */
      height:140px; 
      background:#fff;
      border:2px solid #455A64; border-radius:8px;
      box-shadow:4px 4px 12px rgba(0,0,0,0.15);
      overflow:hidden;
      transform-origin:left center;
      touch-action:none;
      margin-top: 20px; /* ã‚¬ã‚¤ãƒ‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨é‡ãªã‚‰ãªã„ã‚ˆã†ã« */
    }

    /* ã‚¹ãƒˆãƒ©ã‚¤ãƒ—ï¼ˆè‰²ä»˜ã‘ï¼‰ãƒ¬ã‚¤ãƒ¤ãƒ¼ */
    #stripes-layer{ position:absolute; inset:0; pointer-events:none; }
    .stripe{
      position:absolute; top:0;
      height:25px; 
      pointer-events:none;
      transform: translateZ(0);
      transition: height 0.3s ease, opacity 0.3s ease;
    }

    .show-colors .stripe {
        height: 100% !important;
        opacity: 0.6; 
    }

    /* ç›®ç››ã‚Šãƒ¬ã‚¤ãƒ¤ */
    #ticks-layer{ position:absolute; inset:0; pointer-events:none; }

    .tick{
      position:absolute; bottom:0;
      width:2px; background:#37474F; pointer-events:none;
    }
    .tick-1mm{ height:18px; width:1px; background:#546E7A; } 
    .tick-5mm{ height:30px; width:2px; background:#263238; }
    .tick-10mm{ height:45px; width:3px; background:#000; }

    .tick-label{
      position:absolute; bottom:50px; transform:translateX(-50%);
      font-size:1.6rem; font-weight:900; color:#263238;
      pointer-events:none; white-space:nowrap;
      font-feature-settings: "tnum"; 
    }
    
    .text-ud-blue { color: #0D47A1; }   
    .text-ud-orange { color: #BF360C; } 

    /* èµ¤ä¸‰è§’ */
    .tri{
      position:absolute; bottom: 48px;
      width:0; height:0;
      border-left:7px solid transparent;
      border-right:7px solid transparent;
      border-top:10px solid #D50000; 
      transform:translateX(-50%); pointer-events:none;
    }

    /* ===== åŒºé–“å¡—ã‚Š ===== */
    #color-layer{
      position:absolute; top:0; height:100%; width:0; left:0;
      background: rgba(255, 235, 59, 0.5); 
      border-right:4px solid #FBC02D; 
      pointer-events:none; z-index: 10;
    }
    #start-marker{
      position:absolute; bottom:0; height:100%;
      border-left:4px solid #0277BD; 
      display:none; pointer-events:none; z-index: 10;
    }

    /* ===== æ ¡æ­£ãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
    #calibration-modal{
      position:fixed; inset:0; background:rgba(38, 50, 56, 0.95);
      display:none; justify-content:center; align-items:center;
      z-index:999; color:#fff; flex-direction:column;
      padding:20px; gap:16px; touch-action:none;
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }
    #calibration-modal h2{ margin:0; font-size:1.4rem; color:#ECEFF1; text-align: center;}
    #calibration-modal p{ margin:0; text-align:center; line-height:1.6; color:#B0BEC5; font-size: 0.95rem; }
    #calibration-box{
      background:#fff; color:#000;
      display:flex; justify-content:center; align-items:center;
      border-radius:6px; text-align:center; font-size:.95rem; font-weight:bold;
      padding:10px; border:2px solid #ccc;
    }
    .calib-controls{ display:flex; gap:14px; align-items:center; justify-content:center; flex-wrap:wrap; width: 100%; }
    input[type="range"]{ width:min(500px, 80%); height:30px; touch-action:manipulation; }
    #btn-close-calib{ background:#fff; color:#263238; font-weight:900; padding:12px 30px; margin-top: 10px;}

    /* ===== æ‹¡å¤§ãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
    #zoom-modal{
      position:fixed; inset:0; background:rgba(0,0,0,0.7);
      display:none; justify-content:center; align-items:center; /* ä¸­å¤®è¡¨ç¤ºã«å¤‰æ›´ */
      z-index:998; padding:20px; touch-action:none;
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }
    .zoom-sheet{
      width:min(900px, 95%);
      max-height: 95%;
      background:#fff; border-radius:16px;
      box-shadow:0 4px 30px rgba(0,0,0,0.5);
      padding:16px; display:flex; flex-direction:column; gap:12px;
    }
    .zoom-top{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .zoom-title{ font-size:1.2rem; font-weight:900; margin-right:auto; color:#263238; }
    
    .zoom-viewport{
      position:relative; width:100%; height:160px; /* å°‘ã—ç¸®å° */
      background:#FAFAFA; border-radius:12px; overflow:hidden;
      border:2px solid #CFD8DC; touch-action:none;
    }
    .zoom-centerline{
      position:absolute; top:0; bottom:0; left:50%;
      width:0; border-left:4px solid #D50000; 
      pointer-events:none; z-index: 20; opacity: 0.7;
    }
    #zoom-ruler{
      position:absolute; left:0; top:50%; transform:translateY(-50%);
      height:130px; background:#fff;
      border:2px solid #455A64; border-radius:8px;
      overflow:hidden;
    }
    #zoom-stripes{ position:absolute; inset:0; pointer-events:none; }
    #zoom-ticks{ position:absolute; inset:0; pointer-events:none; }
    #zoom-color{
      position:absolute; top:0; height:100%; width:0; left:0;
      background: rgba(255, 235, 59, 0.4);
      border-right:4px solid #FBC02D; pointer-events:none;
    }
    .zoom-controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content: center; }
    .zoom-controls button{ font-size:1rem; padding:10px 18px; border-radius:12px; border:1px solid #CFD8DC; }
    #zoom-close{ background:#ECEFF1; color:#263238; }
    #zoom-minus,#zoom-plus{ background:#fff; color:#263238; font-weight:bold; }
    #zoom-factor{ background:#00796B; color:#fff; border:none; }
    #zoom-center{ width:100%; margin-top:5px; }

    /* æ¨ªå‘ãï¼ˆãƒ©ãƒ³ãƒ‰ã‚¹ã‚±ãƒ¼ãƒ—ï¼‰æ™‚ã®å¾®èª¿æ•´ */
    @media (orientation: landscape) and (max-height: 500px) {
      .controls { padding: 5px 10px; }
      button { padding: 6px 10px; font-size: 0.9rem; }
      #ruler-container { height: 130px; }
      .tick-label { font-size: 1.4rem; bottom: 40px; }
      .tri { bottom: 38px; }
      #guide-msg { font-size: 0.9rem; top: 5px; }
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="controls">
      <div class="btn-group">
        <button id="btn-calibrate">âš™ï¸ èª¿æ•´</button>
        <div class="readout" id="readout">é•·ã•ï¼šâ€”</div>
      </div>
      <div class="btn-group">
        <button id="btn-color">ğŸ¨ ã„ã‚</button>
        <button id="btn-zoom">ğŸ” æ‹¡å¤§</button>
        <button id="btn-reset">â†º æ¶ˆã™</button>
      </div>
    </div>

    <div id="workspace">
      <div id="guide-msg">
        ç‰©ã‚’ç½®ã„ã¦ <b>é•·æŠ¼ã—</b> â†’ æŒ‡ã§ãªãã‚‹
      </div>

      <div id="ruler-container" aria-label="ã‚‚ã®ã•ã—">
        <div id="stripes-layer"></div>
        <div id="color-layer"></div>
        <div id="start-marker"></div>
        <div id="ticks-layer"></div>
      </div>
    </div>
  </div>

  <div id="calibration-modal" role="dialog" aria-modal="true">
    <h2>å¤§ãã•ã®èª¿æ•´</h2>
    <p>
      ç”»é¢ã®ç™½ã„æ ã‚’ã€æ‰‹æŒã¡ã®ã‚«ãƒ¼ãƒ‰ï¼ˆã‚¯ãƒ¬ã‚«ç­‰ï¼‰ã¨<br>
      <b>åŒã˜å¹…ï¼ˆ85.6mmï¼‰</b>ã«åˆã‚ã›ã¦ãã ã•ã„ã€‚
    </p>
    <div id="calibration-box">ã“ã“ã«ã‚«ãƒ¼ãƒ‰ã‚’é‡ã­ã‚‹</div>
    <div class="calib-controls">
      <span>å°</span>
      <input type="range" id="px-per-mm-slider" min="2.00" max="8.50" step="0.01" value="3.78">
      <span>å¤§</span>
    </div>
    <button id="btn-close-calib">å®Œäº†</button>
  </div>

  <div id="zoom-modal" role="dialog" aria-modal="true">
    <div class="zoom-sheet">
      <div class="zoom-top">
        <div class="zoom-title">ğŸ” æ‹¡å¤§è¡¨ç¤º</div>
        <button id="zoom-close">é–‰ã˜ã‚‹</button>
      </div>

      <div class="zoom-viewport">
        <div class="zoom-centerline"></div>
        <div id="zoom-ruler">
          <div id="zoom-stripes"></div>
          <div id="zoom-color"></div>
          <div id="zoom-ticks"></div>
        </div>
      </div>

      <div class="zoom-controls">
        <button id="zoom-minus">ï¼</button>
        <button id="zoom-factor">x3</button>
        <button id="zoom-plus">ï¼‹</button>
      </div>
      <input type="range" id="zoom-center" min="0" max="200" step="1" value="0">
    </div>
  </div>

<script>
(() => {
  // ===== è¨­å®š =====
  const STORAGE_KEY = "ruler_px_per_mm_vUD";
  const DEFAULT_PPM = 3.78;
  const RULER_LENGTH_MM = 200;
  const LONGPRESS_MS = 250;

  // UDé…è‰²è¨­å®š
  const COLOR_EVEN = "#42A5F5"; 
  const COLOR_ODD  = "#FF7043"; 
  const COLOR_GAP  = "rgba(0,0,0,0.03)"; 

  const STRIPE_H_MAIN = 25;
  const STRIPE_H_ZOOM = 25;

  // ===== è¦ç´ å–å¾— =====
  const rulerContainer = document.getElementById("ruler-container");
  const stripesLayer   = document.getElementById("stripes-layer");
  const ticksLayer     = document.getElementById("ticks-layer");
  const colorLayer     = document.getElementById("color-layer");
  const startMarker    = document.getElementById("start-marker");

  const btnZoom      = document.getElementById("btn-zoom");
  const btnReset     = document.getElementById("btn-reset");
  const btnCalibrate = document.getElementById("btn-calibrate");
  const btnColor     = document.getElementById("btn-color");

  const modalCal     = document.getElementById("calibration-modal");
  const sliderPPM    = document.getElementById("px-per-mm-slider");
  const btnCloseCal  = document.getElementById("btn-close-calib");
  const calibBox     = document.getElementById("calibration-box");

  const readout = document.getElementById("readout");

  const zoomModal     = document.getElementById("zoom-modal");
  const zoomClose     = document.getElementById("zoom-close");
  const zoomRuler     = document.getElementById("zoom-ruler");
  const zoomStripes   = document.getElementById("zoom-stripes");
  const zoomTicks     = document.getElementById("zoom-ticks");
  const zoomColor     = document.getElementById("zoom-color");
  const zoomCenter    = document.getElementById("zoom-center");
  const zoomMinus     = document.getElementById("zoom-minus");
  const zoomPlus      = document.getElementById("zoom-plus");
  const zoomFactorBtn = document.getElementById("zoom-factor");

  // ===== çŠ¶æ…‹å¤‰æ•° =====
  let pxPerMm = DEFAULT_PPM;
  let paintActive = false;
  let pressTimer = null;
  let pointerId = null;
  let startMm = null;
  let endMm = null;

  let zoomOpen = false;
  let zoomFactor = 3; 
  let zoomCenterMm = 0;
  let isColorMode = false;

  const clamp = (v,min,max)=>Math.max(min, Math.min(max,v));
  const mmToPx = (mm)=> mm * pxPerMm;

  function mmFromClientX(clientX){
    const rect = rulerContainer.getBoundingClientRect();
    let x = clientX - rect.left;
    x = clamp(x, 0, rect.width);
    const mm = Math.round(x / pxPerMm);
    return clamp(mm, 0, RULER_LENGTH_MM);
  }

  function formatLen(mm){
    if (mm == null) return "â€”";
    const cm = mm / 10;
    return `${cm.toFixed(1)}cm <span style="font-size:0.8em; color:#555">(${mm}mm)</span>`;
  }

  function setReadout(){
    if (startMm == null || endMm == null){
      readout.innerHTML = `é•·ã•ï¼šâ€”`;
      return;
    }
    const a = Math.min(startMm, endMm);
    const b = Math.max(startMm, endMm);
    const len = Math.max(1, b - a);
    readout.innerHTML = `é•·ã•ï¼š${formatLen(len)}`;
  }

  function getStripeColor(i){
    const cmBlock = Math.floor(i / 10);
    const isEvenBlock = (cmBlock % 2 === 0);
    const baseColor = isEvenBlock ? COLOR_EVEN : COLOR_ODD;
    if (i % 2 === 0) {
        return baseColor;
    } else {
        return COLOR_GAP;
    }
  }

  function drawRuler(){
    stripesLayer.innerHTML = "";
    ticksLayer.innerHTML = "";
    const totalWidth = RULER_LENGTH_MM * pxPerMm;
    rulerContainer.style.width = `${totalWidth}px`;

    for (let i = 0; i < RULER_LENGTH_MM; i++){
      const s = document.createElement("div");
      s.className = "stripe";
      s.style.left = `${(i * pxPerMm).toFixed(2)}px`;
      s.style.width = `${pxPerMm.toFixed(2)}px`;
      s.style.height = `${STRIPE_H_MAIN}px`;
      s.style.background = getStripeColor(i);
      stripesLayer.appendChild(s);
    }

    for (let i = 0; i <= RULER_LENGTH_MM; i++){
      const x = i * pxPerMm;
      const tick = document.createElement("div");
      tick.classList.add("tick");
      tick.style.left = `${x.toFixed(2)}px`;

      if (i % 10 === 0){
        tick.classList.add("tick-10mm");
        const tri = document.createElement("div");
        tri.className = "tri";
        tri.style.left = `${x.toFixed(2)}px`;
        ticksLayer.appendChild(tri);

        const label = document.createElement("div");
        label.classList.add("tick-label");
        label.innerText = i / 10;
        label.style.left = `${x.toFixed(2)}px`;
        
        if ((i/10) % 2 === 0) label.classList.add("text-ud-blue");
        else label.classList.add("text-ud-orange");
        ticksLayer.appendChild(label);
      } else if (i % 5 === 0){
        tick.classList.add("tick-5mm");
      } else {
        tick.classList.add("tick-1mm");
      }
      ticksLayer.appendChild(tick);
    }
    applyPaint();
  }

  function applyPaint(){
    if (startMm == null || endMm == null){
      colorLayer.style.width = "0px";
      colorLayer.style.left  = "0px";
      startMarker.style.display = "none";
      setReadout();
      return;
    }
    const a = Math.min(startMm, endMm);
    const b = Math.max(startMm, endMm);

    colorLayer.style.left  = `${mmToPx(a)}px`;
    colorLayer.style.width = `${Math.max(1, mmToPx(b-a))}px`;

    startMarker.style.display = "block";
    startMarker.style.left = `${mmToPx(startMm)}px`;

    setReadout();
    if (zoomOpen) applyZoomPaint();
  }

  document.addEventListener("touchmove", (e)=>{
    const t = e.target;
    if (t && (t.tagName === "INPUT" || t.closest("#zoom-viewport"))) return; 
    if (t.type === "range") return;
    e.preventDefault();
  }, {passive:false});

  function clearPressTimer(){
    if (pressTimer){ clearTimeout(pressTimer); pressTimer = null; }
  }

  function onPointerDown(e){
    if (zoomOpen) return;
    e.preventDefault();
    rulerContainer.setPointerCapture(e.pointerId);
    pointerId = e.pointerId;

    const mm = mmFromClientX(e.clientX);
    paintActive = false;
    clearPressTimer();
    pressTimer = setTimeout(()=>{
      pressTimer = null;
      paintActive = true;
      startMm = mm;
      endMm = mm;
      applyPaint();
      if(navigator.vibrate) navigator.vibrate(15);
    }, LONGPRESS_MS);
  }

  function onPointerMove(e){
    if (zoomOpen) return;
    if (pointerId !== e.pointerId) return;
    e.preventDefault();
    if (!paintActive) return;
    endMm = mmFromClientX(e.clientX);
    applyPaint();
  }

  function onPointerUp(e){
    if (zoomOpen) return;
    if (pointerId !== e.pointerId) return;
    e.preventDefault();
    clearPressTimer();
    if (!paintActive){ pointerId = null; return; }
    if (startMm != null && endMm != null && startMm === endMm){
      endMm = clamp(endMm + 1, 0, RULER_LENGTH_MM);
    }
    paintActive = false;
    pointerId = null;
    applyPaint();
  }

  function onPointerCancel(){ clearPressTimer(); paintActive = false; pointerId = null; }

  rulerContainer.addEventListener("pointerdown", onPointerDown);
  rulerContainer.addEventListener("pointermove", onPointerMove);
  rulerContainer.addEventListener("pointerup", onPointerUp);
  rulerContainer.addEventListener("pointercancel", onPointerCancel);

  btnReset.addEventListener("click", ()=>{ startMm = null; endMm = null; applyPaint(); });

  btnColor.addEventListener("click", () => {
    isColorMode = !isColorMode;
    const action = isColorMode ? "add" : "remove";
    rulerContainer.classList[action]("show-colors");
    zoomRuler.classList[action]("show-colors");
    btnColor.classList[action]("active");
    btnColor.innerHTML = isColorMode ? "ğŸ¨ ã„ã‚ ON" : "ğŸ¨ ã„ã‚";
  });

  function updateCalibrationBox(){
    const w = 85.60 * pxPerMm;
    const h = 54.00 * pxPerMm;
    calibBox.style.width  = `${w}px`;
    calibBox.style.height = `${h}px`;
    drawRuler();
    if (zoomOpen) rebuildZoomRuler();
  }
  btnCalibrate.addEventListener("click", ()=> modalCal.style.display = "flex");
  btnCloseCal.addEventListener("click", ()=> {
    modalCal.style.display = "none";
    localStorage.setItem(STORAGE_KEY, String(pxPerMm));
  });
  sliderPPM.addEventListener("input", (e)=>{
    pxPerMm = parseFloat(e.target.value);
    updateCalibrationBox();
  });

  function rebuildZoomRuler(){
    const pxPerMmZoom = pxPerMm * zoomFactor;
    const totalWidth = RULER_LENGTH_MM * pxPerMmZoom;
    zoomStripes.innerHTML = "";
    zoomTicks.innerHTML = "";
    zoomRuler.style.width = `${totalWidth}px`;

    for (let i = 0; i < RULER_LENGTH_MM; i++){
      const s = document.createElement("div");
      s.className = "stripe";
      s.style.left = `${(i * pxPerMmZoom).toFixed(2)}px`;
      s.style.width = `${pxPerMmZoom.toFixed(2)}px`;
      s.style.height = `${STRIPE_H_ZOOM}px`;
      s.style.background = getStripeColor(i);
      zoomStripes.appendChild(s);
    }

    for (let i = 0; i <= RULER_LENGTH_MM; i++){
      const x = i * pxPerMmZoom;
      const tick = document.createElement("div");
      tick.classList.add("tick");
      tick.style.left = `${x.toFixed(2)}px`;
      if (i % 10 === 0){
        tick.classList.add("tick-10mm");
        const tri = document.createElement("div");
        tri.className = "tri";
        tri.style.left = `${x.toFixed(2)}px`;
        zoomTicks.appendChild(tri);
        const label = document.createElement("div");
        label.classList.add("tick-label");
        label.innerText = i / 10;
        label.style.left = `${x.toFixed(2)}px`;
        if ((i/10) % 2 === 0) label.classList.add("text-ud-blue");
        else label.classList.add("text-ud-orange");
        zoomTicks.appendChild(label);
      } else if (i % 5 === 0){
        tick.classList.add("tick-5mm");
      } else {
        tick.classList.add("tick-1mm");
      }
      zoomTicks.appendChild(tick);
    }
    applyZoomPaint();
    updateZoomPosition();
  }

  function applyZoomPaint(){
    if (startMm == null || endMm == null){
      zoomColor.style.width = "0px"; zoomColor.style.left = "0px"; return;
    }
    const pxPerMmZoom = pxPerMm * zoomFactor;
    const a = Math.min(startMm, endMm);
    const b = Math.max(startMm, endMm);
    zoomColor.style.left  = `${(a * pxPerMmZoom).toFixed(2)}px`;
    zoomColor.style.width = `${Math.max(1, (b-a) * pxPerMmZoom).toFixed(2)}px`;
  }

  function updateZoomPosition(){
    const viewport = zoomRuler.parentElement;
    const vpW = viewport.clientWidth;
    const pxPerMmZoom = pxPerMm * zoomFactor;
    const totalWidth = RULER_LENGTH_MM * pxPerMmZoom;
    
    zoomCenterMm = clamp(zoomCenterMm, 0, RULER_LENGTH_MM);
    
    const centerPx = zoomCenterMm * pxPerMmZoom;
    let tx = (vpW/2) - centerPx;
    tx = clamp(tx, vpW - totalWidth, 0); 
    if(totalWidth < vpW) tx = (vpW - totalWidth)/2;

    zoomRuler.style.transform = `translate(${tx}px, -50%)`;
  }

  function openZoom(){
    zoomOpen = true;
    zoomModal.style.display = "flex";
    btnZoom.style.background = "#d32f2f";
    btnZoom.textContent = "ğŸ” é–‰ã˜ã‚‹";
    
    if(startMm != null && endMm != null) zoomCenterMm = Math.round((startMm + endMm)/2);
    else zoomCenterMm = 100;

    zoomCenter.value = String(zoomCenterMm);
    zoomFactorBtn.textContent = `x${zoomFactor}`;
    
    rebuildZoomRuler();
    if(isColorMode) zoomRuler.classList.add("show-colors");
  }

  function closeZoom(){
    zoomOpen = false;
    zoomModal.style.display = "none";
    btnZoom.style.background = "#00796B";
    btnZoom.textContent = "ğŸ” æ‹¡å¤§";
  }

  btnZoom.addEventListener("click", ()=>{ if (!zoomOpen) openZoom(); else closeZoom(); });
  zoomClose.addEventListener("click", closeZoom);
  
  zoomCenter.addEventListener("input", (e)=>{ 
    zoomCenterMm = parseInt(e.target.value, 10); 
    updateZoomPosition(); 
  });
  
  zoomMinus.addEventListener("click", ()=>{ zoomFactor = clamp(zoomFactor - 1, 2, 5); zoomFactorBtn.textContent = `x${zoomFactor}`; rebuildZoomRuler(); });
  zoomPlus.addEventListener("click", ()=>{ zoomFactor = clamp(zoomFactor + 1, 2, 5); zoomFactorBtn.textContent = `x${zoomFactor}`; rebuildZoomRuler(); });

  window.addEventListener("resize", ()=>{ if (zoomOpen) updateZoomPosition(); });

  function init(){
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved && isFinite(Number(saved))) pxPerMm = parseFloat(saved);
    sliderPPM.value = String(pxPerMm);
    updateCalibrationBox();
    setReadout();
  }
  init();
})();
</script>
</body>
</html>
